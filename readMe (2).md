# Техническое задание: Сохранение состояния данных в приложении Filmorate

## Описание задачи

В рамках текущего спринта необходимо усовершенствовать приложение Filmorate, добавив функциональность для сохранения состояния данных после перезапуска. К концу задания приложение должно корректно работать с базой данных, обеспечивая сохранение данных о фильмах и пользователях.

## Организация работы

В этом спринте вы будете работать в новой ветке. Название ветки: `add-database`.

## Создание базы данных

1. В этом спринте используется база данных **H2**, которая не требует отдельной установки и может быть встроена в приложение.
2. База будет работать в двух режимах:
    - **Режим тестирования**: H2 будет хранить данные в памяти, что позволяет быстро запускать базу для тестов и удалять данные после их завершения.
    - **Рабочий режим**: H2 будет хранить данные в файле на жёстком диске, что обеспечивает сохранность данных между запусками приложения.

3. Добавьте в проект следующие зависимости:
    - `com.h2database.h2`
    - `org.springframework.boot.spring-boot-starter-jdbc`
    - `org.springframework.boot.spring-boot-starter-test`

4. Настройте базу данных в файле `application.properties`:
   ```properties
   spring.sql.init.mode=always
   spring.datasource.url=jdbc:h2:file:./db/filmorate
   spring.datasource.driverClassName=org.h2.Driver
   spring.datasource.username=sa
   spring.datasource.password=password

5. Реализуйте схему базы данных, как было описано в предыдущем спринте. Используйте встроенные инструменты (например, IntelliJ IDEA или DBeaver) для подключения к базе.

6. Обновите модели данных в коде и добавьте необходимые поля.

7. Соберите SQL-запросы для создания структуры базы данных в файл schema.sql, который будет исполняться при каждом запуске приложения. Если необходимо инициализировать данные, создайте файл data.sql.

Пример:
```
CREATE TABLE IF NOT EXISTS films (...);
INSERT INTO films (...) VALUES (...);
```

###Работа с DAO
1. Напишите новые имплементации интерфейсов UserStorage и FilmStorage — это будут DAO-объекты для работы с базой данных.

2. Создайте мапперы и методы для сохранения пользователей и фильмов в базу данных и для извлечения этих данных.

Пример:
```
@Qualifier("userDbStorage")
public class UserDbStorage implements UserStorage {
    // Реализация методов сохранения и получения пользователей
}

```

###Тестирование
1. Для проверки работы с базой данных реализуйте интеграционное тестирование с помощью аннотаций @JdbcTest и @AutoConfigureTestDatabase.
2. Пример:
 ```
@JdbcTest
@AutoConfigureTestDatabase
@RequiredArgsConstructor(onConstructor_ = @Autowired)
@Import({UserDbStorage.class})
public class FilmorateApplicationTests {
    private final UserDbStorage userStorage;

    @Test
    public void testFindUserById() {
        Optional<User> userOptional = userStorage.findUserById(1);
        assertThat(userOptional)
            .isPresent()
            .hasValueSatisfying(user -> 
                assertThat(user).hasFieldOrPropertyWithValue("id", 1)
            );
    }
}

```


###Доработка бизнес-логики

1. Добавьте новые эндпоинты для получения жанров и рейтингов:

- GET /genres — возвращает список всех жанров.
- GET /genres/{id} — возвращает жанр по идентификатору.
- GET /mpa — возвращает список всех рейтингов.
- GET /mpa/{id} — возвращает рейтинг по идентификатору.

2. При создании и обновлении фильмов передавайте список идентификаторов жанров и рейтинг.

3. Измените логику дружбы: теперь дружба будет односторонней, то есть если пользователь отправил запрос в друзья, он будет в списке ваших друзей, а вы в его — нет.

###Финальная проверка
1. Проверьте, что ваше приложение работает корректно.
2. Используйте тесты Postman (sprint.json) для дополнительной проверки.
3. Убедитесь, что все публичные методы хранилища покрыты тестами.
